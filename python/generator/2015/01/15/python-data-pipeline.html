<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Data pipelines with python generators</title>
  <meta name="description" content="Introduction">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://spiet.nl/blog/python/generator/2015/01/15/python-data-pipeline.html">
  <link rel="alternate" type="application/atom+xml" title="Daniël's lab." href="http://spiet.nl/blog/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Daniël's lab.</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/blog/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Data pipelines with python generators</h1>
    <p class="post-meta">Jan 15, 2015</p>
  </header>

  <article class="post-content">
    <h2 id="introduction">Introduction</h2>

<p>When you need to process a large amount of data, chaining <a href="https://wiki.python.org/moin/Generators">python generators</a>
is a nice way to setup processing pipelines. Advantage of this method are
that you have fine grained control over memory usage and it provides an
easy way of defining the pipelines.</p>

<p>At the end of this post we can define pipelines as follows:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pijp</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">open_file_node</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">),</span>
    <span class="n">parse_csv_node</span><span class="p">,</span>
    <span class="n">make_upper_node</span><span class="p">,</span>
    <span class="n">print_line_node</span><span class="p">,</span>
<span class="p">]</span></code></pre></div>

<h2 id="the-codes">The codes</h2>

<p>Lets walk through the different parts of the code. It is assumed you are
familiar with <a href="https://wiki.python.org/moin/Generators">python generators</a>.</p>

<p>We start with importing <code>csv</code> and <code>itertools</code>. The <code>itertools</code> module is
not used in the example code included in this post, but it provides some
very nice utilities. </p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;daniel&#39;</span></code></pre></div>

<h3 id="a-basic-processing-node">A basic processing node</h3>

<p>I chose to call each of the processing steps a Node. We start with
implementing a No Operation node to demonstrate the simplest node.</p>

<p>The generator iterates over the input data and yields each item 
unmodified.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">null_node</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Does nothing, a null operation.</span>

<span class="sd">    :param data: Any iterable</span>
<span class="sd">    :type data: iterable</span>
<span class="sd">    :return: the input</span>
<span class="sd">    :rtype: generator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">datum</span></code></pre></div>

<p>Running this:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">null_node</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">null_node</span> <span class="n">at</span> <span class="mh">0x1227d20</span><span class="o">&gt;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nb">list</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span></code></pre></div>

<p>Debug printing is usually very annoying an inefficient, but we all do it
from time to time right? In any case it makes a nice example for a
processing node that as <a href="http://en.wikipedia.org/wiki/Side_effect_(computer_science)">side-effect</a> has a output to <code>stdout</code>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">debug_node</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print input and output. Yield unmodified.</span>

<span class="sd">    :param data:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;{0} yielded {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datum</span><span class="p">))</span>
        <span class="k">yield</span> <span class="n">datum</span></code></pre></div>

<p>Running this:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="nb">list</span><span class="p">(</span><span class="n">debug_node</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">0</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">1</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">2</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">3</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">4</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">5</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">6</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">7</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">8</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="n">yielded</span> <span class="mi">9</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span></code></pre></div>

<h3 id="a-node-to-split-an-iterable-into-chunks">A node to split an iterable into chunks</h3>

<p>When inserting data into a database it is efficient to do this multiple
rows at a time. Lets make a node that makes chunks of size 3. Larger
chunks are more realistic, but for demostration purpose we use a small
size. </p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">chunk_gen</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c"># so we can pass in any iterator or sequence and `next()` it</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">chunk</span>
            <span class="n">chunk</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">chunk</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="nb">list</span><span class="p">(</span><span class="n">chunk_gen</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">]]</span></code></pre></div>

<h3 id="static-config-values-on-a-node">Static config values on a node</h3>

<p>How cool would it be if we can configure these nodes at pipeline definition
time? We would need some place to store this information. Maybe a class could 
work, passing configuration values to the constructor and a method for the
actual generator. I haven’t tried this, another option is to take advantage
of <a href="http://en.wikipedia.org/wiki/Closure_(computer_programming)">closures</a>:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">make_chunks_node</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Chunks the data stream.</span>

<span class="sd">    With size of 2: (1,2,3,4,5) -&gt; ((1,2),(3,4),(5))</span>
<span class="sd">    Example of a node that reduces data.</span>

<span class="sd">    Useful for database inserts.</span>
<span class="sd">    :param size: Chunk size</span>
<span class="sd">    :return:</span>
<span class="sd">    :rtype: generator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># we love closures, use it to store size</span>

    <span class="k">def</span> <span class="nf">chunk_gen</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">chunk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="k">yield</span> <span class="n">chunk</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">chunk</span>

    <span class="k">return</span> <span class="n">chunk_gen</span></code></pre></div>

<p>This allows us to make the following construction, we pass the config
value to the method that returns the actual generator:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">35</span><span class="p">]:</span> <span class="n">gen</span> <span class="o">=</span> <span class="n">make_chunks_node</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="nb">list</span><span class="p">(</span><span class="n">gen</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span></code></pre></div>

<h3 id="more-nodes">More nodes</h3>

<p>Other examples of nodes are:</p>

<ul>
  <li><code>open_file_node</code>, takes an iterable of filenames and yields file-like objects</li>
  <li><code>parse_csv_node</code>, takes an iterable of text lines and yields data rows</li>
  <li><code>make_upper_node</code>, takes an iterable of iterables and yields lists for each
inner iterable with their items uppercased</li>
  <li><code>print_line_node</code>, same as debug node without printing the source</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">open_file_node</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Opens given file names given on input and yields file like objects</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">gen_open_file_node</span><span class="p">(</span><span class="n">file_names</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">fo</span>
    <span class="k">return</span> <span class="n">gen_open_file_node</span>


<span class="k">def</span> <span class="nf">parse_csv_node</span><span class="p">(</span><span class="n">csv_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse CSV rows from input data</span>

<span class="sd">    :param csv_data: file like object containing CSV</span>
<span class="sd">    :return: CSV rows as lists</span>
<span class="sd">    :rtype: generator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">csv_datum</span> <span class="ow">in</span> <span class="n">csv_data</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_datum</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">row</span>


<span class="k">def</span> <span class="nf">make_upper_node</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Example of a 1 to 1 processing node</span>

<span class="sd">    :param rows:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
        <span class="c"># yield (x.upper() for x in row)</span>


<span class="k">def</span> <span class="nf">print_line_node</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the input and yield unmodified</span>

<span class="sd">    :param lines:</span>
<span class="sd">    :return:</span>
<span class="sd">    :rtype: generator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">line</span></code></pre></div>

<h2 id="chaining-generators">Chaining generators</h2>

<p>Now we have some nodes, we need to have a way to chain them all together.
The following method does that by accepting a list of nodes and a source
iterable. The source is passed to the first generator in the nodes list. The 
generator returned by the first node is then passed as an argument to the next
node and so on until there are no more nodes in the list. Finally the generator
returned by the last node is returned. Iterating this last generator sets the
whole pipeline in motion.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">make_pipe</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Chain all nodes and return the last</span>

<span class="sd">    Make a combined generator where the source is passed to</span>
<span class="sd">    the first generator in nodes. The generator returned by it</span>
<span class="sd">    is then passed on the the next node, etc.</span>

<span class="sd">    :param source:</span>
<span class="sd">    :param nodes:</span>
<span class="sd">    :return: combined, chained generator</span>
<span class="sd">    :rtype: generator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">source</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">node</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gen</span></code></pre></div>

<h2 id="defining-pipelines">Defining pipelines</h2>

<p>Putting it all together we get something like this:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c"># define pipeline</span>
    <span class="n">pijp</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">make_chunks_node</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
        <span class="n">print_line_node</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c"># make a pipe generator</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipe</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">pijp</span><span class="p">)</span>
    <span class="c"># consume all</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>

    <span class="n">pijp</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">debug_node</span><span class="p">,</span>
        <span class="n">open_file_node</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">),</span>
        <span class="n">debug_node</span><span class="p">,</span>
        <span class="n">parse_csv_node</span><span class="p">,</span>
        <span class="n">debug_node</span><span class="p">,</span>
        <span class="n">make_upper_node</span><span class="p">,</span>
        <span class="n">debug_node</span><span class="p">,</span>
        <span class="n">print_line_node</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="nb">list</span><span class="p">(</span><span class="n">make_pipe</span><span class="p">([</span><span class="s">&#39;test1.csv&#39;</span><span class="p">,</span> <span class="s">&#39;test2.csv&#39;</span><span class="p">],</span> <span class="n">pijp</span><span class="p">))</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">]</span>
<span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">]</span>
<span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">]</span>
<span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">]</span>
<span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">]</span>
<span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">]</span>
<span class="p">[</span><span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">79</span><span class="p">]</span>
<span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">89</span><span class="p">]</span>
<span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">]</span>
<span class="p">[</span><span class="s">&#39;test1.csv&#39;</span><span class="p">,</span> <span class="s">&#39;test2.csv&#39;</span><span class="p">]</span> <span class="n">yielded</span> <span class="n">test1</span><span class="o">.</span><span class="n">csv</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">gen_open_file_node</span> <span class="n">at</span> <span class="mh">0x0000000003CF8F30</span><span class="o">&gt;</span> <span class="n">yielded</span> <span class="o">&lt;</span><span class="n">_io</span><span class="o">.</span><span class="n">TextIOWrapper</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;test1.csv&#39;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;rt&#39;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">parse_csv_node</span> <span class="n">at</span> <span class="mh">0x0000000003D29240</span><span class="o">&gt;</span> <span class="n">yielded</span> <span class="p">[</span><span class="s">&#39;HEADER1&#39;</span><span class="p">,</span> <span class="s">&#39;HEADER2&#39;</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">make_upper_node</span> <span class="n">at</span> <span class="mh">0x0000000003D29F30</span><span class="o">&gt;</span> <span class="n">yielded</span> <span class="p">[</span><span class="s">&#39;HEADER1&#39;</span><span class="p">,</span> <span class="s">&#39;HEADER2&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s">&#39;HEADER1&#39;</span><span class="p">,</span> <span class="s">&#39;HEADER2&#39;</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">parse_csv_node</span> <span class="n">at</span> <span class="mh">0x0000000003D29240</span><span class="o">&gt;</span> <span class="n">yielded</span> <span class="p">[</span><span class="s">&#39;data11&#39;</span><span class="p">,</span> <span class="s">&#39;data 92&#39;</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">make_upper_node</span> <span class="n">at</span> <span class="mh">0x0000000003D29F30</span><span class="o">&gt;</span> <span class="n">yielded</span> <span class="p">[</span><span class="s">&#39;DATA11&#39;</span><span class="p">,</span> <span class="s">&#39;DATA 92&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s">&#39;DATA11&#39;</span><span class="p">,</span> <span class="s">&#39;DATA 92&#39;</span><span class="p">]</span>
<span class="o">...</span>
<span class="p">[</span><span class="s">&#39;test1.csv&#39;</span><span class="p">,</span> <span class="s">&#39;test2.csv&#39;</span><span class="p">]</span> <span class="n">yielded</span> <span class="n">test2</span><span class="o">.</span><span class="n">csv</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">gen_open_file_node</span> <span class="n">at</span> <span class="mh">0x0000000003CF8F30</span><span class="o">&gt;</span> <span class="n">yielded</span> <span class="o">&lt;</span><span class="n">_io</span><span class="o">.</span><span class="n">TextIOWrapper</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;test2.csv&#39;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;rt&#39;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">parse_csv_node</span> <span class="n">at</span> <span class="mh">0x0000000003D29240</span><span class="o">&gt;</span> <span class="n">yielded</span> <span class="p">[</span><span class="s">&#39;HEADER3&#39;</span><span class="p">,</span> <span class="s">&#39;HEADER4&#39;</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">make_upper_node</span> <span class="n">at</span> <span class="mh">0x0000000003D29F30</span><span class="o">&gt;</span> <span class="n">yielded</span> <span class="p">[</span><span class="s">&#39;HEADER3&#39;</span><span class="p">,</span> <span class="s">&#39;HEADER4&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s">&#39;HEADER3&#39;</span><span class="p">,</span> <span class="s">&#39;HEADER4&#39;</span><span class="p">]</span>
<span class="o">...</span></code></pre></div>

<h2 id="conclusion-and-future">Conclusion and Future</h2>

<p>I like the result of this experiment. Although I didn’t take care of any
exception handling nor did I try to use for something serious I think this
can work. One thing I am not sure about is something like progress reporting.
If each node knows beforehand how many items it will be processing, they can 
know their own percentage, but how to communicate that. A callable that is 
passed in with the source iterable perhaps…</p>

<p>Nodes can also be used to partition data, like <code>make_chunk_node</code>, and fire
off tasks to be processed in parallel. After jobs become ready, the result
can be yielded.</p>

<p>Probably more cool stuff possible!</p>

<p>Check out the <a href="https://github.com/daniel5gh/">GitHub</a>s for codes.</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Daniël's lab.</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Daniël's lab.</li>
          <li><a href="mailto:daniel5blog@spiet.nl">daniel5blog@spiet.nl</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Blog about all kinds of (code) experiments.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
